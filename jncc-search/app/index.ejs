<%
var visiblePagesBeforeOrAfterCurrentPage = Math.floor(queryParams.pageSize/2)-1;
var totalPages = Math.ceil(hits.total/queryParams.pageSize);

function getPaginationStart(page, pageSize) {
    if (page <= visiblePagesBeforeOrAfterCurrentPage) {
        return 1;
    } else if ((page + visiblePagesBeforeOrAfterCurrentPage) >= totalPages) {
        return totalPages - pageSize + 1;
    } else {
        return page - visiblePagesBeforeOrAfterCurrentPage;
    }
}
function getPaginationEnd(page, pageSize) {
    if (page <= visiblePagesBeforeOrAfterCurrentPage) {
        return pageSize;
    } else if ((page + visiblePagesBeforeOrAfterCurrentPage) >= totalPages) {
        return totalPages;
    } else {
        return page + visiblePagesBeforeOrAfterCurrentPage;
    }
}
function getPaginationLink(queryParams, page) {
    var params = [];

    if (queryParams.queryTerms && queryParams.queryTerms.length > 0) {
        params.push({
            key: 'q',
            value: queryParams.queryTerms.join('+')
        });
    }
    if (queryParams.view) {
        params.push({
            key: 'v',
            value: queryParams.view
        });
    }
    if (queryParams.sortOption) {
        params.push({
            key: 's',
            value: queryParams.sortOption
        });
    }
    if (queryParams.filters && queryParams.filters.length > 0) {
        params.push({
            key: 'f',
            value: queryParams.filters.join(',')
        });
    }
    params.push({
        key: 'p',
        value: page
    });
    var queryStringParams = updateQueryStringParameters(params);
    return queryStringParams;
}

function updateQueryStringParameters(params) {         
    var uri = "/";
    params.forEach(param => {                
        if (params.indexOf(param) == 0) {
            uri = uri + "?" + param.key + "=" + param.value;
        }
        else {
            uri = uri + "&" + param.key + "=" + param.value;
        }
    });
    
    return uri;
}
%> 
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Example JNCC microsite</title>
    <link rel="stylesheet" href="https://jncc.gov.uk/css/app.css">
    <link rel="shortcut icon" href="https://jncc.gov.uk/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" defer></script>
    <script>window.jQuery || document.write('<script src="https://jncc.gov.uk/js/lib/jquery-2.2.4.min.js" defer><\/script>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.5.0/js/foundation.min.js" defer></script>
    <script src="https://jncc.gov.uk/js/app.js" defer></script>
</head>
<body>
    <noscript><div>Javascript must be enabled for the correct page display</div></noscript>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
    <script>
        var queryParams = {
            queryTerms: [],
            view: 'pages',
            sort: 'relevance',
            page: 0,
            filters: []
        }

        $(document).ready(function () {
            initialisePage(queryParams);

            $('#main-search-form').submit(function(){
                queryParams.queryTerms = $('#search-input').val().split(' ');
                queryParams.page = 0;
                refreshSearch(queryParams);
                return false; // don't let it actually submit
            });
            $('#pages-tab-link').click(function(){
                queryParams.view = 'pages';
                queryParams.page = 0;
                queryParams.filters = [];
                refreshSearch(queryParams);
                return false; 
            });
            $('#resources-tab-link').click(function(){
                queryParams.view = 'resources';
                queryParams.page = 0;
                refreshSearch(queryParams);
                return false;
            });
            $('#sort-select').change(function(){
                queryParams.sort = this.value;
                queryParams.page = 0;
                refreshSearch(queryParams);
            });
            $('#filter-form').find(':checkbox').change(function(){
                if (this.checked && !queryParams.filters.includes(this.value)) {
                    queryParams.filters.push(this.value);
                } else if (!this.checked && queryParams.filters.includes(this.value)) {
                    queryParams.filters.splice(queryParams.filters.indexOf(this.value), 1);
                }
                refreshSearch(queryParams);
                return false;
            });
        });

        function initialisePage(queryParams) {
            var queryTerms = getQueryVariable('q');
            if (queryTerms) {
                queryParams.queryTerms = queryTerms.split('+');
                $('#search-input').val(queryParams.queryTerms.join(' '));
            }

            var view = getQueryVariable('v');
            if (view) {
                queryParams.view = view;
                if (view === 'resources') {
                    $('#resources-tab-item').addClass('is-active');
                } else {
                    $('#pages-tab-item').addClass('is-active');
                }
            }

            var sort = getQueryVariable('s');
            if (sort) {
                queryParams.sort = sort;
                $('#sort-select').val(queryParams.sort);
            }

            var page = getQueryVariable('p');
            if (page) {
                queryParams.page = page;
            }

            var filters = getQueryVariable('f');
            if (filters) {
                queryParams.filters = filters.split(',');
                queryParams.filters.forEach(filter => {
                    $('#'+filter).prop('checked', true);
                })
            }
        }

        function refreshSearch(queryParams) {
            var params = [];

            if (queryParams.queryTerms && queryParams.queryTerms.length > 0) {
                params.push({
                    key: 'q',
                    value: queryParams.queryTerms.join('+')
                });
            }
            if (queryParams.view) {
                params.push({
                    key: 'v',
                    value: queryParams.view
                });
            }
            if (queryParams.sort) {
                params.push({
                    key: 's',
                    value: queryParams.sort
                });
            }
            if (queryParams.page) {
                params.push({
                    key: 'p',
                    value: queryParams.page
                });
            }
            if (queryParams.filters && queryParams.filters.length > 0) {
                params.push({
                    key: 'f',
                    value: queryParams.filters.join(',')
                });
            }
            console.log(params);
            var queryString = updateQueryStringParameters(params);
            window.location = queryString;
        }

        function updateQueryStringParameters(params) { 
            var baseUrl = window.location.toString().split("?")[0];           
            var uri = baseUrl;
            params.forEach(param => {                
                if (params.indexOf(param) == 0) {
                    uri = uri + "?" + param.key + "=" + param.value;
                }
                else {
                    uri = uri + "&" + param.key + "=" + param.value;
                }
            });
            
            return uri;
        }

        // https://css-tricks.com/snippets/javascript/get-url-variables/
        function getQueryVariable(variable)
        {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                    var pair = vars[i].split("=");
                    if(pair[0] == variable){return pair[1];}
            }
            return(false);
        }
    </script>
    <div id="wrapper">
        <a class="accessibility" href="#main" accesskey="S">Skip to Content</a>
        <header id="header">
            <div class="container">
                <strong class="logo">
                    <a href="#" accesskey="1"><img src="https://jncc.gov.uk/images/logo.png" alt="JNCC"></a>
                </strong>
                <form role="search" class="top-bar search-form input-group" id="search-form" novalidate="novalidate" data-animate="hinge-in-from-top spin-out">
                    <label for="search-field" class="show-for-sr" accesskey="4">Search:</label>
                    <input type="search" name="q" placeholder="Search jncc.gov.uk" class="input-group-field" id="search-field">
                    <button class="input-group-button" aria-label="search-button"><i class="icon-search"></i></button>
                </form>
                <div class="show-for-small-only">
                    <div class="title-bar" data-responsive-toggle="search-form" data-hide-for="medium">
                        <button type="button" class="search-opener" data-toggle="search-form" aria-label="search-opener"><i class="icon-search"></i></button>
                    </div>
                    <div class="title-bar" data-responsive-toggle="menu" data-hide-for="medium">
                        <button type="button" class="nav-opener" data-toggle="menu" data-responsive-toggle="menu" aria-label="navigation-opener"><span></span></button>
                    </div>
                </div>
            </div>
            <nav class="top-bar nav no-page-hero" id="menu" data-animate="hinge-in-from-top spin-out" aria-label="main-navigation">
				<div class="container mobileNavContainer">
					<ul class="vertical medium-horizontal menu dropdown" data-dropdown-menu data-click-open data-alignment="left"
                     style="vertical-align:middle;">
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/our-role/">Our role</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/our-role/the-uk/">The UK</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/our-role/the-offshore-marine-environment/">The offshore marine environment</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/our-role/the-uks-overseas-territories/">The UK&#39;s Overseas Territories</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/our-role/international/">International</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/monitoring/">Monitoring</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/monitoring/cost-effective-approaches/">Cost-effective approaches</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/monitoring/earth-observation/">Earth observation</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/monitoring/marine-monitoring-mapping/">Marine monitoring &amp; mapping</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/monitoring/analyses-trends/">Analyses &amp; trends</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/evaluating/">Evaluating</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/evaluating/sustainable-global-supply-chains/">Sustainable global supply chains</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/evaluating/land-use/">Land use</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/evaluating/climate-change/">Climate change</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/advice/">Advice</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/advice/improving-global-co-ordination-action/">Improving global co-ordination &amp; action</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/advice/offshore-industries/">Offshore Industries</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/advice/marine-protected-areas/">Marine Protected Areas</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/advice/sustainable-development-overseas/">Sustainable development overseas</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/our-work/">Our work</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/our-work/our-work-a-z/">Our work Aâ€“Z</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="~/">Resources</a>
                            <ul class="vertical menu nested">
        						<li class="">
                                    <a href="~/search">Search our resources</a>
                                </li>
                            </ul>
                        </li>
                        <li class="is-dropdown-submenu-parent">
                            <a href="https://jncc.gov.uk/about-jncc/">About JNCC</a>
                            <ul class="vertical menu nested">
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/who-we-are/">Who we are</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/how-we-work/">How we work</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/our-performance/">Our performance</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/corporate-information/">Corporate information</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/jncc-blog/">JNCC Blog</a>
                                </li>
                                <li class="">
                                    <a href="https://jncc.gov.uk/about-jncc/careers/">Careers</a>
                                </li>
                            </ul>
                        </li>
                        <li class="menuitem">
                            <a href="https://jncc.gov.uk/news/">News</a>
                        </li>
					</ul>
				</div>
			</nav>
        </header>

        <p class="container show-for-small-only" style="margin-bottom: 1.5rem;">
            <i class="fas fa-database fa-fw"></i> JNCC Search
        </p>
                
        <main id="main">
            <br />
            <div class="container">
                <h1>Search</h1>
                <div class="grid-x grid-padding-x">
                    <div class="small-9 cell">
                        <label for="sort-select" class="text-right middle">Sort:</label>
                    </div>
                    <div class="small-3 cell">
                        <select id="sort-select" name="s" form="search">
                            <option value="relevance">Relevance</option>
                            <option value="title_asc">Title ascending</option>
                            <option value="title_desc">Title descending</option>
                            <option value="date_asc">Date ascending</option>
                            <option value="date_desc">Date descending</option>
                        </select>
                    </div>
                </div>
                <div class="two-columns stretch-layout staff-directory columns-reverse-layout">
                    <aside id="sidebar">
                        <form id="main-search-form" role="search" class="search-form input-group">
                            <label for="sidebar-search-field">
                                <input id="search-input" type="search" placeholder="Search" class="input-group-field" id="sidebar-search-field" aria-label="Sidebar Search" name="q" form="main-search-form">
                            </label>
                            <button class="input-group-button" aria-label="sidebar-search-button"><i class="icon-search"></i></button>
                        </form>
                        <% if (aggs) { %>
                            <form id="filter-form" class="staff-checkbox-form">
                                <h2>Filter</h2>
                                <hr />
                                <ul class="check-list no-bullet">
                                    <% if (aggs.file_types && aggs.file_types.buckets) { %>
                                        <% aggs.file_types.buckets.forEach(file_type => { %> 
                                            <li>
                                                <label for="<%= file_type.key %>">
                                                    <input id="<%= file_type.key %>" type="checkbox" name="<%= file_type.key %>" value="<%= file_type.key %>">
                                                    <span class="fake-input"></span><span class="fake-label"><%= file_type.key %> (<%= file_type.doc_count %>)</span>
                                                </label>
                                            </li>
                                        <% }) %> 
                                    <% } %>
                                    <% if (aggs.other && aggs.other.doc_count > 0) { %> 
                                        <li>
                                            <label for="other">
                                                <input id="other" type="checkbox" name="other" value="Other">
                                                <span class="fake-input"></span><span class="fake-label">Other (<%= aggs.other.doc_count %>)</span>
                                            </label>
                                        </li>
                                    <% } %>
                                </ul>
                                <hr />
                            </form>
                        <% } %>
                    </aside>
                    <div id="content">
    
                        <ul class="tabs" id="results-tabs">
                            <li id="pages-tab-item" class="tabs-title">
                                <a href="#" id="pages-tab-link" aria-selected="<%= queryParams.view !== 'resources' %>">Pages</a>
                            </li>
                            <li id="resources-tab-item" class="tabs-title">
                                <a href="#" id="resources-tab-link" aria-selected="<%= queryParams.view === 'resources' %>">Resources</a>
                            </li>
                        </ul>
                        <br />
                        <% if (hits && queryParams.view !== 'resources') { %>
                            <p>Pages: <%= hits.total %> results
                            <% if (queryParams.queryTerms && queryParams.queryTerms.length > 0) { %>
                                for '<%= queryParams.queryTerms.join(' ') %>'
                            <% } %>
                            </p>
                            <% hits.hits.forEach(result => { %>
                                <h3><a href="<%- result._source.url %>"><%- result._source.title %></a></h3>
                                <span><b>Published date</b>: <%= result._source.published_date %></span>
                                <% if (result.highlight && result.highlight.content) { %>
                                <p><%- result.highlight.content %></p>
                                <% } else { %>
                                <p><%- result._source.content_truncated %></p>
                                <% } %>
                                <hr />
                            <% }) %>
                        <% } else if (hits) { %>
                            <p>Resources: <%= hits.total %> results
                            <% if (queryParams.queryTerms && queryParams.queryTerms.length > 0) { %>
                                for '<%= queryParams.queryTerms.join(' ') %>'
                            <% } %>
                            </p>
                            <% hits.hits.forEach(result => { %>
                                <h3><a href="<%- result._source.url %>"><%- result._source.title %></a></h3>
                                <span><b>Published date</b>: <%= result._source.published_date %></span>
                                <span><b>Size</b>: <%= result._source.file_bytes %></span>
                                <span><b>File type</b>: <%= result._source.file_extension ? result._source.file_extension : "Other" %></span> 
                                <% if (result.highlight && result.highlight.content) { %>
                                <p><%- result.highlight.content %></p>
                                <% } else { %>
                                <p><%- result._source.content_truncated %></p>
                                <% } %>
                                <hr />
                            <% }) %>
                        <% } else { %>
                            <p>Oops something went wrong</p>
                        <% } %>
                        <nav aria-label="Pagination" class="results-pager">
                            <ul class="pagination">
                                <% if (queryParams.pageStart === 1) { %>
                                    <li class="pagination-previous disabled">Previous</li>
                                <% } else { %>
                                    <li class="pagination-previous"><a href="<%= getPaginationLink(queryParams, queryParams.pageStart - 1) %>">Previous</a></li>
                                <% } %> 

                                <% if (totalPages > 10) { %>
                                    <%# add ellipsis to shorten list %>
                                    <% if (queryParams.pageStart > visiblePagesBeforeOrAfterCurrentPage) { %>
                                        <%# current page not near start so show page 1 %>
                                        <li><a href="<%= getPaginationLink(queryParams,1) %>">1</a></li>
                                        <% if ((queryParams.pageStart - visiblePagesBeforeOrAfterCurrentPage) !== 2) { %>
                                            <%# don't bother with ellipsis if next number is 2 %>
                                            <li class="ellipsis" aria-hidden="true"></li>
                                        <% } %>
                                    <% } %>
                                    <% for (i = getPaginationStart(queryParams.pageStart, queryParams.pageSize); i <= getPaginationEnd(queryParams.pageStart, queryParams.pageSize); i++) { %>
                                        <%# show the 4 pages either side of current page %>
                                        <% if (i === queryParams.pageStart) { %>
                                            <li class="current">
                                        <% } else { %>
                                            <li>
                                        <% } %>  
                                            <a href="<%= getPaginationLink(queryParams, i) %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    <% if ((queryParams.pageStart + visiblePagesBeforeOrAfterCurrentPage) < totalPages) { %>
                                        <% if ((queryParams.pageStart + visiblePagesBeforeOrAfterCurrentPage) !== (totalPages - 1)) { %>
                                            <%# don't bother with ellipsis if next number is last page %>
                                            <li class="ellipsis" aria-hidden="true"></li>
                                        <% } %>
                                        <%# current page not near start so show last page %>
                                        <li><a href="<%= getPaginationLink(queryParams, totalPages) %>"><%= totalPages %></a></li>
                                    <% } %>
                                <% } else { %>
                                    <%# show all pages without ellipsis %>
                                    <% for (i = 1; i <= totalPages; i++) { %>
                                        <% if (i === queryParams.pageStart) { %> 
                                            <li class="current">
                                        <% } else { %>
                                            <li>
                                        <% } %>  
                                            <a href="<%= getPaginationLink(queryParams, i) %>"><%= i %></a>
                                        </li>
                                    <% } %> 
                                <% } %> 
                                
                                <% if (queryParams.pageStart === totalPages) { %>
                                    <li class="pagination-next disabled">Next</li>
                                <% } else { %>
                                    <li class="pagination-next"><a href="<%= getPaginationLink(queryParams, queryParams.pageStart + 1) %>">Next</a></li>
                                <% } %>
                            </ul>
                        </nav>
                        <br />
                        <br />
                    </div>
                </div>
                
            </div>
        </main>
        <footer id="footer" class="text-center medium-text-left">
			<div class="container">
				<div class="row" id="footer-nav">
					<div class="columns small-12 medium-4">
						<nav class="holder" aria-label="footer-navigation">
							<h3>About us</h3>
							<ul class="footer-nav no-bullet">
								<li><a href="https://jncc.gov.uk/about-jncc/">About JNCC</a></li>
								<li><a href="https://jncc.gov.uk/about-jncc/careers/">Careers</a></li>
								<li><a href="https://jncc.gov.uk/about-jncc/corporate-information/procurement/">Procurement</a></li>
							</ul>
						</nav>
					</div>
					<div class="columns small-12 medium-4">
						<nav class="holder" aria-label="footer-navigation">
							<h3>Our work</h3>
							<ul class="footer-nav no-bullet">
								<li><a href="https://jncc.gov.uk/our-work/our-work-a-z/">Our work A-Z</a></li>
								<li><a href="https://hub.jncc.gov.uk/">Resource hub</a></li>
								<li><a href="https://jncc.gov.uk/about-jncc/jncc-blog/">JNCC Blog</a></li>
								<li><a href="https://jncc.gov.uk/news/">News</a></li>
							</ul>
						</nav>
					</div>
					<div class="columns small-12 medium-4">
						<nav class="holder" aria-label="footer-navigation">
							<h3>Our services</h3>
							<ul class="footer-nav no-bullet">
								<li><a href="https://jncc.gov.uk/our-role/">Our role</a></li>
								<li><a href="https://jncc.gov.uk/monitoring/">Monitoring</a></li>
								<li><a href="https://jncc.gov.uk/evaluating/">Evaluating</a></li>
								<li><a href="https://jncc.gov.uk/advice/">Advice</a></li>
							</ul>
						</nav>
					</div>
				</div>
				<ul class="social-media no-bullet">
					<li><a href="https://twitter.com/JNCC_UK" target="_blank"><span class="show-for-sr">twitter</span><i class="icon-twitter"></i></a></li>
					<li><a href="https://www.facebook.com/JNCCUK" target="_blank"><span class="show-for-sr">facebook</span><i class="icon-facebook"></i></a></li>
					<li><a href="https://www.linkedin.com/company/jncc" target="_blank"><span class="show-for-sr">linkedin</span><i class="icon-linkedin"></i></a></li>
					<li><a href="https://www.youtube.com/channel/UC14QLVv3QA1Xu6Fjdn7GJnw"><span class="show-for-sr">youtube</span><i class="icon-youtube"></i></a></li>
				</ul>
			</div>
			<div class="footer-bottom">
				<div class="container">
					<p>&copy; Joint Nature Conservation Committee, Monkstone House, City Road, Peterborough, PE1 1JY<br>Tel: 01733 562626 Fax: 01733 555948. Contact us:&nbsp;<a href="https://jncc.gov.uk/contact/?ref=hub" title="contact" data-anchor="?ref=hub">Enquiry form</a><br>JNCC SUPPORT CO. Registered in England and Wales. Company no. 05380206. Registered office as above</p>
					<ul class="footer-bottom-list no-bullet info">
						<li><a href="https://jncc.gov.uk/about-jncc/corporate-information/privacy-statement/">Privacy statement</a></li>
						<li><a href="https://jncc.gov.uk/about-jncc/corporate-information/accessibility-statement/">Accessibility statement</a></li>
						<li><a href="https://jncc.gov.uk/about-jncc/corporate-information/cookie-policy/">Cookie policy</a></li>
					</ul>
				</div>
			</div>
		</footer>
    </div>
    <a class="accessibility" href="#wrapper">Back to top</a>
</body>
</html>